name: Deploy to ROSA from ECR

# ============================================================
# Deploys React application to ROSA using image from AWS ECR
# ============================================================

on:
  workflow_dispatch:
    inputs:
      namespace:
        description: 'Target namespace'
        required: true
        default: 'mortgage-app'
      image_tag:
        description: 'ECR image tag to deploy'
        required: true
        default: 'latest'
      replicas:
        description: 'Number of replicas'
        required: true
        default: '2'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - 'development'
          - 'staging'
          - 'production'

env:
  APP_NAME: mortgage-portal
  AWS_REGION: us-east-1
  ECR_REPOSITORY: mortgage-portal

jobs:
  deploy:
    name: Deploy to ROSA
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Verify Image Exists
        run: |
          echo "ğŸ” Verifying image exists in ECR..."
          REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          
          aws ecr describe-images \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --image-ids imageTag=${{ github.event.inputs.image_tag }} \
            || { echo "âŒ Image not found: ${{ github.event.inputs.image_tag }}"; exit 1; }
          
          echo "âœ… Image verified: ${REGISTRY}/${{ env.ECR_REPOSITORY }}:${{ github.event.inputs.image_tag }}"
          echo "image_uri=${REGISTRY}/${{ env.ECR_REPOSITORY }}:${{ github.event.inputs.image_tag }}" >> $GITHUB_ENV

      - name: Install OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xvf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/
          oc version --client

      - name: Login to OpenShift
        run: |
          oc login ${{ secrets.OPENSHIFT_SERVER }} \
            --token=${{ secrets.OPENSHIFT_TOKEN }} \
            --insecure-skip-tls-verify=true

      - name: Setup Namespace
        run: |
          NAMESPACE="${{ github.event.inputs.namespace }}"
          
          if ! oc get namespace $NAMESPACE 2>/dev/null; then
            echo "ğŸ“ Creating namespace: $NAMESPACE"
            oc new-project $NAMESPACE
          else
            echo "ğŸ“ Using existing namespace: $NAMESPACE"
            oc project $NAMESPACE
          fi

      - name: Create ECR Pull Secret
        run: |
          NAMESPACE="${{ github.event.inputs.namespace }}"
          REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          
          echo "ğŸ” Creating ECR pull secret..."
          
          # Get ECR password
          ECR_PASSWORD=$(aws ecr get-login-password --region ${{ env.AWS_REGION }})
          
          # Create or update pull secret
          oc create secret docker-registry ecr-pull-secret \
            --docker-server=${REGISTRY} \
            --docker-username=AWS \
            --docker-password=${ECR_PASSWORD} \
            -n $NAMESPACE \
            --dry-run=client -o yaml | oc apply -f -
          
          # Link to default service account
          oc secrets link default ecr-pull-secret --for=pull -n $NAMESPACE 2>/dev/null || true
          oc secrets link builder ecr-pull-secret -n $NAMESPACE 2>/dev/null || true
          
          echo "âœ… ECR pull secret configured"

      - name: Deploy Application
        run: |
          NAMESPACE="${{ github.event.inputs.namespace }}"
          REPLICAS="${{ github.event.inputs.replicas }}"
          ENVIRONMENT="${{ github.event.inputs.environment }}"
          IMAGE="${{ env.image_uri }}"
          
          echo "ğŸš€ Deploying ${{ env.APP_NAME }} to $NAMESPACE..."
          
          cat <<EOF | oc apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ${{ env.APP_NAME }}
            namespace: ${NAMESPACE}
            labels:
              app: ${{ env.APP_NAME }}
              app.kubernetes.io/name: ${{ env.APP_NAME }}
              app.kubernetes.io/component: frontend
              app.kubernetes.io/part-of: mortgage-system
              environment: ${ENVIRONMENT}
          spec:
            replicas: ${REPLICAS}
            selector:
              matchLabels:
                app: ${{ env.APP_NAME }}
            strategy:
              type: RollingUpdate
              rollingUpdate:
                maxSurge: 1
                maxUnavailable: 0
            template:
              metadata:
                labels:
                  app: ${{ env.APP_NAME }}
                  environment: ${ENVIRONMENT}
                annotations:
                  deployment-timestamp: "$(date +%s)"
                  image-tag: "${{ github.event.inputs.image_tag }}"
              spec:
                containers:
                  - name: ${{ env.APP_NAME }}
                    image: ${IMAGE}
                    imagePullPolicy: Always
                    ports:
                      - name: http
                        containerPort: 8080
                        protocol: TCP
                    env:
                      - name: ENVIRONMENT
                        value: "${ENVIRONMENT}"
                    resources:
                      requests:
                        cpu: 50m
                        memory: 64Mi
                      limits:
                        cpu: 200m
                        memory: 256Mi
                    readinessProbe:
                      httpGet:
                        path: /ready
                        port: 8080
                      initialDelaySeconds: 3
                      periodSeconds: 5
                      timeoutSeconds: 2
                      successThreshold: 1
                      failureThreshold: 3
                    livenessProbe:
                      httpGet:
                        path: /health
                        port: 8080
                      initialDelaySeconds: 5
                      periodSeconds: 15
                      timeoutSeconds: 3
                      successThreshold: 1
                      failureThreshold: 3
                    startupProbe:
                      httpGet:
                        path: /health
                        port: 8080
                      initialDelaySeconds: 2
                      periodSeconds: 5
                      timeoutSeconds: 2
                      failureThreshold: 12
                    securityContext:
                      allowPrivilegeEscalation: false
                      runAsNonRoot: true
                      seccompProfile:
                        type: RuntimeDefault
                      capabilities:
                        drop:
                          - ALL
                imagePullSecrets:
                  - name: ecr-pull-secret
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: ${{ env.APP_NAME }}
            namespace: ${NAMESPACE}
            labels:
              app: ${{ env.APP_NAME }}
          spec:
            selector:
              app: ${{ env.APP_NAME }}
            ports:
              - name: http
                port: 80
                targetPort: 8080
                protocol: TCP
            type: ClusterIP
          ---
          apiVersion: route.openshift.io/v1
          kind: Route
          metadata:
            name: ${{ env.APP_NAME }}
            namespace: ${NAMESPACE}
            labels:
              app: ${{ env.APP_NAME }}
            annotations:
              haproxy.router.openshift.io/timeout: 60s
          spec:
            to:
              kind: Service
              name: ${{ env.APP_NAME }}
              weight: 100
            port:
              targetPort: http
            tls:
              termination: edge
              insecureEdgeTerminationPolicy: Redirect
            wildcardPolicy: None
          EOF

      - name: Wait for Deployment
        run: |
          echo "â³ Waiting for deployment to complete..."
          oc rollout status deployment/${{ env.APP_NAME }} \
            -n ${{ github.event.inputs.namespace }} \
            --timeout=300s

      - name: Get Application URL
        id: url
        run: |
          NAMESPACE="${{ github.event.inputs.namespace }}"
          URL=$(oc get route ${{ env.APP_NAME }} -n $NAMESPACE -o jsonpath='{.spec.host}')
          echo "url=https://${URL}" >> $GITHUB_OUTPUT
          echo "âœ… Application URL: https://${URL}"

      - name: Verify Deployment
        run: |
          NAMESPACE="${{ github.event.inputs.namespace }}"
          
          echo ""
          echo "=== Deployment Status ==="
          oc get deployment ${{ env.APP_NAME }} -n $NAMESPACE
          
          echo ""
          echo "=== Pods ==="
          oc get pods -n $NAMESPACE -l app=${{ env.APP_NAME }}
          
          echo ""
          echo "=== Service ==="
          oc get svc ${{ env.APP_NAME }} -n $NAMESPACE
          
          echo ""
          echo "=== Route ==="
          oc get route ${{ env.APP_NAME }} -n $NAMESPACE
          
          echo ""
          echo "=== Health Check ==="
          sleep 5
          curl -sk "${{ steps.url.outputs.url }}/health" && echo " - OK" || echo " - Pending"

      - name: Summary
        run: |
          echo "## ğŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Application Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| URL | ${{ steps.url.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Namespace | \`${{ github.event.inputs.namespace }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ github.event.inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | \`${{ github.event.inputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Replicas | ${{ github.event.inputs.replicas }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ env.image_uri }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Open Application](${{ steps.url.outputs.url }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Dashboard](${{ steps.url.outputs.url }}/)" >> $GITHUB_STEP_SUMMARY
          echo "- [Customers](${{ steps.url.outputs.url }}/customers)" >> $GITHUB_STEP_SUMMARY
          echo "- [Properties](${{ steps.url.outputs.url }}/properties)" >> $GITHUB_STEP_SUMMARY
          echo "- [Loan Applications](${{ steps.url.outputs.url }}/loans)" >> $GITHUB_STEP_SUMMARY
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  MORTGAGE PORTAL DEPLOYED TO ROSA"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  URL: ${{ steps.url.outputs.url }}"
          echo "  Image: ${{ env.image_uri }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
